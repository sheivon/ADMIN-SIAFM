@{
    ViewBag.Title = "RevivirSFP";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="card">
    <div class="card-header bg-success row py-1">
        <h5 class="text-white col-3">Revivir Solicitud Presupuestaria</h5>
        <div class="col d-inline-flex justify-content-end">
            <label class="col-form-label-sm text-light" for="year">Del base</label>
            <select class="form-select-sm mx-2" id="year">
                <option value="2022">2022</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
            </select>
            <input id="txtsp" class="form-control form-control-sm" placeholder="Solicitud Presupuesto" />
            <button id="btnSearch" class="btn btn-sm"><i class="fa fa-search"></i></button>
        </div>
    </div>
    <div class="card-body">
        <table class="table table-sm table-responsive-sm table-hover" id="tblcpres">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Año</th>
                    <th>Solicitado por</th>
                    <th>Concepto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section scripts {
    <script>
    $(document).ready(function () {
        // Initialize DataTable blank
        initTblCpres();

        $('#btnSearch').on('click', function () {
            reloadTblCpres();
        });

        //$('#year').on('change', reloadTblCpres);
    });

    function initTblCpres() {
        if ($.fn.DataTable.isDataTable('#tblcpres')) {
            $('#tblcpres').DataTable().clear().destroy();
        }

        $('#tblcpres').DataTable({
            ajax: {
                url: '@Url.Action("Soli_Pres", "Home")',
                type: 'GET',
                data: function (d) {
                    d.yr = $('#year').val();
                    d.sp = $('#txtsp').val().trim();
                },
                dataSrc: 'data',
                error: function () {
                    swal({ icon: 'error', title: 'Error loading data.' });
                }
            },
            searching: false,
            columns: [
                { data: 'EPPTO_ID' },
                { data: 'ANO' },
                { data: 'SOLICITADO_POR' },
                { data: 'CONCEPTO' },
                { data: 'FECHA', render: function (data) { return formatDate(data); } },
                { data: 'ESTADO' },
                {
                    data: null,
                    className: 'text-center',
                    defaultContent: `
                        <button class="btn btn-sm btn-primary btn-edit"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-sm btn-danger btn-delete"><i class="fas fa-trash"></i></button>`,
                    orderable: false,
                    searchable: false,
                    width: '100px'
                }
            ]
        });
    }

    function reloadTblCpres() {
        if (!$.fn.DataTable.isDataTable('#tblcpres')) {
            initTblCpres();
        } else {
            $('#tblcpres').DataTable().ajax.reload();
        }
    }

    function formatDate(data) {
        // Function to format date (only date, no time) 
        if (!data) return '';
        const match = /\/Date\((\d+)\)\//.exec(data);
        if (match) {
            const date = new Date(parseInt(match[1]));
            return date.toLocaleDateString(); // Only returns date part
        }
        return 'Invalid Date'; 
    }
    </script>
}
